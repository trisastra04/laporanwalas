<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Bulanan Murid</title>
    <!-- Menggunakan Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan Papa Parse untuk membaca file CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Menggunakan font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Mengaplikasikan font Inter ke seluruh halaman */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk loader animasi */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* CSS untuk memisahkan tampilan layar dan cetak */
        @media screen {
            #printableArea {
                display: none;
            }
        }

        @media print {
            body {
                background-color: white !important;
            }
            #loginScreen, header, footer, #studentSelectorSection, #printButtons, #analysisSection, #reportContainer > .container > div > header {
                display: none !important;
            }
            #reportContainer, main {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .container, .bg-white {
                box-shadow: none !important;
                border: none !important;
            }
            .page-break {
                page-break-before: always;
            }
            .page-break:first-child {
                page-break-before: auto; /* Mencegah halaman kosong di awal saat mencetak semua */
            }
             #printableArea {
                display: block !important;
            }
            #reportContent {
                 display: none !important; /* Sembunyikan tampilan interaktif saat mencetak */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Halaman Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-200">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login Wali Kelas</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="loginId" class="block text-sm font-medium text-gray-700 mb-1">ID Pengguna</label>
                    <input type="text" id="loginId" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <div class="relative">
                        <input type="password" id="loginPassword" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 focus:outline-none">
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                             <svg id="eyeSlashIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .9-2.857 3.12-5.234 5.93b-1.295-1.295a1 1 0 011.414-1.414l1.295 1.295A3.007 3.007 0 0112 9c1.657 0 3 1.343 3 3a3.007 3.007 0 01-.175 1.005l1.295 1.295a1 1 0 01-1.414 1.414l-1.295-1.295z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.542 7A10.05 10.05 0 0012 5c-1.82 0-3.536.5-5.064 1.362M12 15a3 3 0 110-6 3 3 0 010 6z" />
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Masuk</button>
                <p id="loginError" class="text-red-500 text-sm text-center mt-4 hidden"></p>
            </form>
        </div>
    </div>


    <!-- Kontainer utama untuk seluruh laporan -->
    <div id="reportContainer" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <header class="bg-blue-600 text-white p-6 text-center">
                    <h1 class="text-2xl md:text-3xl font-bold">LAPORAN BULANAN MURID</h1>
                </header>
                
                <div id="loader" class="flex justify-center items-center p-16">
                    <div class="loader"></div>
                    <p class="ml-4 text-gray-600">Memuat data...</p>
                </div>

                <main class="p-6 md:p-8 space-y-8 hidden" id="reportContent">
                    <section class="hidden">
                        <input type="password" id="apiKey" value="AIzaSyBGJ_7iwQ-Zss3jBoRdwBrUiyJIGHaNCxg">
                    </section>
                    
                    <section id="studentSelectorSection">
                         <label for="studentSelector" class="block text-sm font-medium text-gray-700 mb-2">Pilih Siswa:</label>
                         <select id="studentSelector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                             <option>Memuat daftar siswa...</option>
                         </select>
                    </section>
                    
                    <!-- Tombol Cetak -->
                    <section id="printButtons" class="flex justify-end space-x-4">
                         <button id="printCurrentBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                             Cetak Laporan Siswa Ini
                         </button>
                         <button id="printAllBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                             Cetak Laporan Semua Siswa
                         </button>
                    </section>

                    <!-- Area Laporan Tunggal -->
                    <div id="singleReportArea" class="space-y-8">
                        <section class="border-b pb-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">NAMA</p>
                                    <p id="studentName" class="font-semibold text-lg">-</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">KELAS</p>
                                    <p id="studentClass" class="font-semibold text-lg">-</p>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h2 class="text-xl font-bold mb-4 text-blue-700">A. Persentase Kehadiran</h2>
                            <div class="rounded-lg border border-gray-200">
                                <table class="w-full table-fixed divide-y-2 divide-gray-200 bg-white text-sm">
                                    <colgroup>
                                        <col style="width: 5%;">
                                        <col style="width: 25%;">
                                        <col style="width: 50%;">
                                        <col style="width: 20%;">
                                    </colgroup>
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">No</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Mata Pelajaran</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Tanggal dan Keterangan Tidak Hadir</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Persentase</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceBody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </section>

                        <section>
                            <h2 class="text-xl font-bold mb-4 text-blue-700">B. Catatan Wali Kelas</h2>
                            <div class="rounded-lg border border-gray-200">
                                <table class="w-full table-fixed divide-y-2 divide-gray-200 bg-white text-sm">
                                     <colgroup>
                                        <col style="width: 5%;">
                                        <col style="width: 20%;">
                                        <col style="width: 37.5%;">
                                        <col style="width: 37.5%;">
                                    </colgroup>
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">No</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Tanggal</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Pelanggaran</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Catatan Wali Kelas</th>
                                        </tr>
                                    </thead>
                                    <tbody id="homeroomNotesBody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </section>

                        <section>
                            <h2 class="text-xl font-bold mb-4 text-blue-700">C. Catatan Guru Mata Pelajaran</h2>
                            <div class="rounded-lg border border-gray-200">
                                 <table class="w-full table-fixed divide-y-2 divide-gray-200 bg-white text-sm">
                                     <colgroup>
                                        <col style="width: 5%;">
                                        <col style="width: 20%;">
                                        <col style="width: 25%;">
                                        <col style="width: 50%;">
                                    </colgroup>
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">No</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Tanggal</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Mata Pelajaran</th>
                                            <th class="px-4 py-3 font-semibold text-left text-gray-900">Catatan Guru</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subjectNotesBody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </section>
                    </div>

                    <section id="analysisSection">
                        <h2 class="text-xl font-bold mb-4 text-blue-700">D. Analisis</h2>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <div class="flex flex-col items-center text-center">
                                <p class="text-gray-700 mb-4">Dapatkan ringkasan performa dan saran pengembangan untuk siswa ini secara otomatis.</p>
                                <button id="generateAnalysisBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                    ✨ Buat Analisis & Saran
                                </button>
                                <div id="analysisLoader" class="hidden mt-4">
                                    <div class="loader"></div>
                                    <p class="text-gray-600 ml-2 mt-2">Sedang menganalisis data...</p>
                                </div>
                                <div id="analysisResult" class="mt-6 text-left w-full prose max-w-none"></div>
                            </div>
                        </div>
                    </section>
                </main>
                
                <div id="printableArea"></div>
                
                <footer class="text-center p-4 bg-gray-50 text-xs text-gray-500 border-t">
                    <p>&copy; 2025 Laporan Akademik Siswa. Hak Cipta Dilindungi.</p>
                </footer>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Variabel Global ---
            const loginScreen = document.getElementById('loginScreen');
            const reportContainer = document.getElementById('reportContainer');
            const loginForm = document.getElementById('loginForm');
            const loginIdInput = document.getElementById('loginId');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginError = document.getElementById('loginError');
            const togglePasswordBtn = document.getElementById('togglePassword');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeSlashIcon = document.getElementById('eyeSlashIcon');
            const loader = document.getElementById('loader');
            const reportContent = document.getElementById('reportContent');
            const studentSelector = document.getElementById('studentSelector');
            const studentNameEl = document.getElementById('studentName');
            const studentClassEl = document.getElementById('studentClass');
            const attendanceBody = document.getElementById('attendanceBody');
            const homeroomNotesBody = document.getElementById('homeroomNotesBody');
            const subjectNotesBody = document.getElementById('subjectNotesBody');
            const apiKeyInput = document.getElementById('apiKey');
            const generateAnalysisBtn = document.getElementById('generateAnalysisBtn');
            const analysisLoader = document.getElementById('analysisLoader');
            const analysisResult = document.getElementById('analysisResult');
            const printCurrentBtn = document.getElementById('printCurrentBtn');
            const printAllBtn = document.getElementById('printAllBtn');
            const printableArea = document.getElementById('printableArea');

            // --- URL Data ---
            const loginDataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQYfxjM8ILsrY-6Cu46YcWS6Ettb6tx1pp0lK_x10lG-EXG1GNqlk2w_p_aRyh-5uUkL2HCPUvWRedQ/pub?gid=348488556&single=true&output=csv';
            const studentDataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwT9XaQAUcv9X810Lj-71wJkzZjkGS2NNfqqfp4_9Qbfd8fWuTvVadOnKCQ7ltb6iJ3ldPtMM2a95w/pub?gid=878520612&single=true&output=csv';
            const homeroomNotesUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQYfxjM8ILsrY-6Cu46YcWS6Ettb6tx1pp0lK_x10lG-EXG1GNqlk2w_p_aRyh-5uUkL2HCPUvWRedQ/pub?gid=921636477&single=true&output=csv';
            const subjectNotesUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwT9XaQAUcv9X810Lj-71wJkzZjkGS2NNfqqfp4_9Qbfd8fWuTvVadOnKCQ7ltb6iJ3ldPtMM2a95w/pub?gid=960037403&single=true&output=csv';
            const attendanceDataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwT9XaQAUcv9X810Lj-71wJkzZjkGS2NNfqqfp4_9Qbfd8fWuTvVadOnKCQ7ltb6iJ3ldPtMM2a95w/pub?gid=889076089&single=true&output=csv';
            
            // --- Penyimpanan Data ---
            let loginCredentials = [], allStudentData = [], allHomeroomNotes = [], allSubjectNotes = [], allAttendanceData = [];

            // --- Fungsi Universal ---
            function parseCsvData(url) {
                const cacheBusterUrl = `${url}&_=${new Date().getTime()}`;
                return new Promise((resolve, reject) => {
                    Papa.parse(cacheBusterUrl, {
                        download: true, skipEmptyLines: true, header: false,
                        complete: results => {
                            if (results.data.length === 0) return resolve([]);
                            const headers = results.data[0].map(h => h ? h.trim() : '');
                            const data = results.data.slice(1).map(row => {
                                let record = {};
                                headers.forEach((header, index) => {
                                    if (header) record[header] = row[index];
                                });
                                return record;
                            });
                            resolve(data);
                        },
                        error: error => reject(error)
                    });
                });
            }

            // --- Logika Login ---
            async function loadLoginData() {
                try {
                    loginCredentials = await parseCsvData(loginDataUrl);
                } catch (error) {
                    console.error('Gagal memuat data login:', error);
                    loginError.textContent = 'Gagal memuat data login. Coba lagi nanti.';
                    loginError.classList.remove('hidden');
                }
            }
            loadLoginData();

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = loginIdInput.value;
                const password = loginPasswordInput.value;
                const validUser = loginCredentials.find(user => user.ID === id && user.Password === password);
                if (validUser) {
                    loginScreen.classList.add('hidden');
                    reportContainer.classList.remove('hidden');
                    loadAllData();
                } else {
                    loginError.textContent = 'ID atau password salah.';
                    loginError.classList.remove('hidden');
                }
            });

            togglePasswordBtn.addEventListener('click', () => {
                const isPassword = loginPasswordInput.type === 'password';
                loginPasswordInput.type = isPassword ? 'text' : 'password';
                eyeIcon.classList.toggle('hidden', isPassword);
                eyeSlashIcon.classList.toggle('hidden', !isPassword);
            });

            // --- Logika Laporan ---
            async function loadAllData() {
                try {
                    [allStudentData, allHomeroomNotes, allSubjectNotes, allAttendanceData] = await Promise.all([
                        parseCsvData(studentDataUrl), parseCsvData(homeroomNotesUrl), parseCsvData(subjectNotesUrl), parseCsvData(attendanceDataUrl)
                    ]);
                    populateStudentSelector();
                    loader.style.display = 'none';
                    reportContent.classList.remove('hidden');
                    if (allStudentData.length > 0) {
                        displayStudentReport(studentSelector.value);
                    }
                } catch (error) {
                    console.error('Gagal memuat data laporan:', error);
                    loader.innerHTML = '<p class="text-red-500">Gagal memuat data laporan.</p>';
                }
            }

            function populateStudentSelector() {
                studentSelector.innerHTML = '';
                if (allStudentData.length === 0) {
                     studentSelector.innerHTML = '<option disabled>Tidak ada data siswa</option>';
                     return;
                }
                allStudentData.forEach(student => {
                    const studentName = student['Nama Siswa'];
                    if(studentName && studentName.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = studentName;
                        option.textContent = studentName;
                        studentSelector.appendChild(option);
                    }
                });
            }
            
            function displayStudentReport(selectedName) {
                analysisResult.innerHTML = ''; // Hapus analisis lama
                const studentInfo = allStudentData.find(s => s['Nama Siswa'] === selectedName);
                if (studentInfo) {
                    studentNameEl.textContent = studentInfo['Nama Siswa'] || '-';
                    studentClassEl.textContent = studentInfo['Kelas'] || '-';
                }
                
                attendanceBody.innerHTML = generateAttendanceHtml(selectedName);
                homeroomNotesBody.innerHTML = generateHomeroomNotesHtml(selectedName);
                subjectNotesBody.innerHTML = generateSubjectNotesHtml(selectedName);
            }

            function generateAttendanceHtml(selectedName) {
                let html = '';
                const uniqueSubjects = [...new Set(allAttendanceData.map(record => record['Mapel'] || record['Mata Pelajaran']).filter(Boolean))];
                let attendanceCounter = 0;
                const validAbsenceCodes = ['S', 'I', 'A', 'P'];

                uniqueSubjects.forEach(subjectName => {
                    attendanceCounter++;
                    const subjectRecords = allAttendanceData.filter(record => (record['Mapel'] || record['Mata Pelajaran']) === subjectName);
                    const totalMeetings = subjectRecords.length;
                    const studentAbsences = subjectRecords.filter(record => {
                        const absenceCode = record[selectedName];
                        return absenceCode && validAbsenceCodes.includes(absenceCode.trim().toUpperCase());
                    });
                    const totalAbsences = studentAbsences.length;
                    const percentage = totalMeetings > 0 ? (((totalMeetings - totalAbsences) / totalMeetings) * 100) : 0;
                    const absenceDetails = studentAbsences.map(record => {
                        const date = record['Tanggal'] || record['tanggal'] || '-';
                        const absenceCode = record[selectedName].trim().toUpperCase();
                        return `${date} (${absenceCode})`;
                    }).join(', ');

                    html += `<tr>
                        <td class="px-4 py-3 font-medium text-gray-900">${attendanceCounter}</td>
                        <td class="px-4 py-3 text-gray-700 break-words">${subjectName}</td>
                        <td class="px-4 py-3 text-gray-700 break-words">${absenceDetails || '-'}</td>
                        <td class="px-4 py-3 text-gray-700">${percentage.toFixed(0)}%</td>
                    </tr>`;
                });

                if (attendanceCounter === 0) html = '<tr><td colspan="4" class="px-4 py-3 text-gray-500 text-center">Tidak ada data kehadiran.</td></tr>';
                return html;
            }

            function generateHomeroomNotesHtml(selectedName) {
                 let html = '';
                 const studentHomeroomNotes = allHomeroomNotes.filter(note => note['Nama Siswa'] && note['Nama Siswa'].trim().toUpperCase() === selectedName.trim().toUpperCase());
                if (studentHomeroomNotes.length > 0) {
                    studentHomeroomNotes.forEach((note, index) => {
                        html += `<tr>
                            <td class="px-4 py-3 font-medium text-gray-900">${index + 1}</td>
                            <td class="px-4 py-3 text-gray-700">${note['Tanggal'] || '-'}</td>
                            <td class="px-4 py-3 text-gray-700 break-words">${note['Pelanggaran'] || '-'}</td>
                            <td class="px-4 py-3 text-gray-700 break-words">${note['Catatan Wali Kelas'] || '-'}</td>
                        </tr>`;
                    });
                } else {
                    html = '<tr><td colspan="4" class="px-4 py-3 text-gray-500 text-center">Tidak ada catatan.</td></tr>';
                }
                return html;
            }

            function generateSubjectNotesHtml(selectedName) {
                let html = '';
                let subjectNoteCounter = 0;
                const validAbsenceCodes = ['S', 'I', 'A', 'P'];
                allSubjectNotes.forEach(record => {
                    const note = record[selectedName]; 
                    if (note && note.trim() !== '' && !validAbsenceCodes.includes(note.trim().toUpperCase())) {
                        subjectNoteCounter++;
                        const date = record['Tanggal'] || record['tanggal'] || '-';
                        const subjectName = record['Mapel'] || record['Mata Pelajaran'] || '-';
                        html += `<tr>
                            <td class="px-4 py-3 font-medium text-gray-900">${subjectNoteCounter}</td>
                            <td class="px-4 py-3 text-gray-700">${date}</td>
                            <td class="px-4 py-3 text-gray-700 break-words">${subjectName}</td>
                            <td class="px-4 py-3 text-gray-700 break-words">${note}</td>
                        </tr>`;
                    }
                });

                if (subjectNoteCounter === 0) html = '<tr><td colspan="4" class="px-4 py-3 text-gray-500 text-center">Tidak ada catatan.</td></tr>';
                return html;
            }

            function generateFullReportHtml(studentName, includeAnalysis = false) {
                const studentInfo = allStudentData.find(s => s['Nama Siswa'] === studentName);
                const studentClass = studentInfo ? studentInfo['Kelas'] : '-';
                const attendanceHtml = generateAttendanceHtml(studentName);
                const homeroomNotesHtml = generateHomeroomNotesHtml(studentName);
                const subjectNotesHtml = generateSubjectNotesHtml(studentName);
                
                let analysisSectionHtml = '';
                if (includeAnalysis) {
                    const analysisContent = analysisResult.innerHTML.trim() !== '' ? analysisResult.innerHTML : '<p class="text-gray-500 text-center">Analisis belum dibuat.</p>';
                    analysisSectionHtml = `
                        <section>
                            <h3 class="text-xl font-bold mb-4 text-blue-700">D. Analisis</h3>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                <div class="text-left w-full prose max-w-none">${analysisContent}</div>
                            </div>
                        </section>
                    `;
                }

                return `
                    <div class="page-break p-6 md:p-8 space-y-8">
                         <section class="border-b pb-6">
                            <h2 class="text-2xl font-bold text-center mb-4">LAPORAN BULANAN MURID</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><p class="text-sm text-gray-500">NAMA</p><p class="font-semibold text-lg">${studentName}</p></div>
                                <div><p class="text-sm text-gray-500">KELAS</p><p class="font-semibold text-lg">${studentClass}</p></div>
                            </div>
                        </section>
                        <section>
                            <h3 class="text-xl font-bold mb-4 text-blue-700">A. Persentase Kehadiran</h3>
                            <div class="rounded-lg border border-gray-200">
                                <table class="w-full table-fixed divide-y-2 divide-gray-200 bg-white text-sm">
                                    <colgroup><col style="width: 5%;"><col style="width: 25%;"><col style="width: 50%;"><col style="width: 20%;"></colgroup>
                                    <thead class="bg-gray-50"><tr><th class="px-4 py-3 font-semibold text-left text-gray-900">No</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Mata Pelajaran</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Tanggal dan Keterangan Tidak Hadir</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Persentase</th></tr></thead>
                                    <tbody class="divide-y divide-gray-200">${attendanceHtml}</tbody>
                                </table>
                            </div>
                        </section>
                        <section>
                            <h3 class="text-xl font-bold mb-4 text-blue-700">B. Catatan Wali Kelas</h3>
                            <div class="rounded-lg border border-gray-200">
                                <table class="w-full table-fixed divide-y-2 divide-gray-200 bg-white text-sm">
                                    <colgroup><col style="width: 5%;"><col style="width: 20%;"><col style="width: 37.5%;"><col style="width: 37.5%;"></colgroup>
                                    <thead class="bg-gray-50"><tr><th class="px-4 py-3 font-semibold text-left text-gray-900">No</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Tanggal</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Pelanggaran</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Catatan Wali Kelas</th></tr></thead>
                                    <tbody class="divide-y divide-gray-200">${homeroomNotesHtml}</tbody>
                                </table>
                            </div>
                        </section>
                        <section>
                            <h3 class="text-xl font-bold mb-4 text-blue-700">C. Catatan Guru Mata Pelajaran</h3>
                            <div class="rounded-lg border border-gray-200">
                                <table class="w-full table-fixed divide-y-2 divide-gray-200 bg-white text-sm">
                                     <colgroup><col style="width: 5%;"><col style="width: 20%;"><col style="width: 25%;"><col style="width: 50%;"></colgroup>
                                    <thead class="bg-gray-50"><tr><th class="px-4 py-3 font-semibold text-left text-gray-900">No</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Tanggal</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Mata Pelajaran</th><th class="px-4 py-3 font-semibold text-left text-gray-900">Catatan Guru</th></tr></thead>
                                    <tbody class="divide-y divide-gray-200">${subjectNotesHtml}</tbody>
                                </table>
                            </div>
                        </section>
                        ${analysisSectionHtml}
                    </div>
                `;
            }
            
            async function generateAnalysis() {
                const selectedName = studentSelector.value;
                const apiKey = apiKeyInput.value;
                if (!apiKey) {
                    analysisResult.innerHTML = `<p class="text-yellow-600 text-center">Analisis tidak dapat dibuat karena API Key tidak valid.</p>`;
                    return;
                }
                analysisResult.innerHTML = '';
                analysisLoader.classList.remove('hidden');
                analysisLoader.style.display = 'flex';
                generateAnalysisBtn.disabled = true;

                let notesText = `Berikut adalah catatan untuk siswa bernama ${selectedName}:\n\n`;
                const homeroomNotes = allHomeroomNotes.filter(note => note['Nama Siswa'] && note['Nama Siswa'].trim().toUpperCase() === selectedName.trim().toUpperCase());
                if (homeroomNotes.length > 0) {
                    notesText += "Catatan Wali Kelas:\n";
                    homeroomNotes.forEach(note => {
                        notesText += `- Tanggal ${note['Tanggal']}, Pelanggaran: ${note['Pelanggaran']}, Catatan: ${note['Catatan Wali Kelas']}\n`;
                    });
                }
                let subjectNotesCount = 0;
                let subjectNotesText = "Catatan Guru Mata Pelajaran:\n";
                allSubjectNotes.forEach(record => {
                    const note = record[selectedName];
                     if (note && note.trim() !== '' && !['S', 'I', 'A', 'P'].includes(note.trim().toUpperCase())) {
                        subjectNotesCount++;
                        subjectNotesText += `- Mapel ${record['Mapel'] || record['Mata Pelajaran'] || 'N/A'} (Tanggal ${record['Tanggal'] || record['tanggal'] || 'N/A'}): ${note}\n`;
                    }
                });
                if (subjectNotesCount > 0) notesText += "\n" + subjectNotesText;

                if (homeroomNotes.length === 0 && subjectNotesCount === 0) {
                    analysisResult.innerHTML = `<p class="text-gray-600 text-center">Tidak ada catatan untuk dianalisis.</p>`;
                    analysisLoader.style.display = 'none';
                     generateAnalysisBtn.disabled = false;
                    return;
                }

                const systemPrompt = "Anda adalah seorang konselor pendidikan. Analisis catatan siswa untuk memberikan ringkasan performa dan saran yang membangun.";
                const userPrompt = `${notesText}\n\nBerdasarkan catatan di atas, berikan:\n1. **Ringkasan Performa Siswa:** Soroti kekuatan dan area yang perlu perhatian.\n2. **Saran dan Langkah Selanjutnya:** Poin-poin konkret untuk siswa dan orang tua.\n\nGunakan format Markdown (heading, bullet points). Jawab dalam Bahasa Indonesia.`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userPrompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        }),
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    analysisResult.innerHTML = markdownToHtml(result.candidates[0].content.parts[0].text);
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    analysisResult.innerHTML = `<p class="text-red-500">Terjadi kesalahan. Pastikan API Key benar. Error: ${error.message}</p>`;
                } finally {
                    analysisLoader.style.display = 'none';
                    generateAnalysisBtn.disabled = false;
                }
            }

            function markdownToHtml(text) {
                text = text.replace(/\*\*(.*?)\*\*/g, '<h3 class="text-lg font-bold mt-4 mb-2 text-gray-800">$1</h3>');
                text = text.replace(/^\s*\*\s+(.*)/gm, '<li class="ml-5 list-disc">$1</li>');
                text = text.replace(/(\<li.*?\<\/li\>)+/gs, '<ul>$&</ul>');
                return text;
            }

            // --- Event Listeners ---
            studentSelector.addEventListener('change', (e) => displayStudentReport(e.target.value));
            generateAnalysisBtn.addEventListener('click', generateAnalysis);
            
            printCurrentBtn.addEventListener('click', () => {
                printableArea.innerHTML = generateFullReportHtml(studentSelector.value, true);
                setTimeout(() => { window.print(); }, 100);
            });

            printAllBtn.addEventListener('click', () => {
                printableArea.innerHTML = ''; 
                allStudentData.forEach(student => {
                    if (student['Nama Siswa']) {
                        printableArea.innerHTML += generateFullReportHtml(student['Nama Siswa'], false);
                    }
                });
                setTimeout(() => { window.print(); }, 100);
            });
            
            window.addEventListener('afterprint', () => {
                printableArea.innerHTML = ''; 
            });

        });
    </script>
</body>
</html>

